# N+1 ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œ?

> ì´ ê¸€ì€ íŒ€ì› [ë¸Œë£¨ë‹ˆ](https://github.com/23Yong)ì´ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.
> 

í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©° ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œë¥¼ í•´ê²°í•´ì•¼í–ˆìŠµë‹ˆë‹¤.

> **`ì¿ í°ê·¸ë£¹` ì¡°íšŒì‹œ `ì¿ í°ê·¸ë£¹` ë‚´ì˜ `ì¿ í°` ë“¤ì˜ ì´ë¦„ê³¼ `ì¿ í°ê·¸ë£¹`ë“¤ì˜ [ì”ì—¬ ê°œìˆ˜ / ì´ê°œìˆ˜] ë¥¼ ê³„ì‚°í•˜ê³  í˜ì´ì§• ì²˜ë¦¬í•˜ì—¬ `ì¿ í°ê·¸ë£¹` ëª©ë¡ì„ ë°˜í™˜**
> 

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê³¼ì •ì„ í¬ìŠ¤íŒ…í•´ë³´ë ¤ í•©ë‹ˆë‹¤.

## í…Œì´ë¸”ê°„ì˜ ê´€ê³„

`ì¿ í°ê·¸ë£¹` ê³¼ `ì¿ í°` ì€ ë‹¤ìŒê³¼ ê°™ì€ ì—°ê´€ê´€ê³„ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/woowa-coupons/tech-blog/assets/66981851/c8f64cad-692d-497d-b6ac-ca9c073dfc90)


ìœ„ì˜ ê·¸ë¦¼ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ `ì¿ í°ê·¸ë£¹` ê³¼ `ì¿ í°`ì€ **ì¼ëŒ€ë‹¤ ì—°ê´€ê´€ê³„**ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. í•˜ë‚˜ì˜ `ì¿ í°ê·¸ë£¹` ì¡°íšŒì‹œ ì—¬ëŸ¬ê°œì˜ `ì¿ í°` ì„ ë³´ì—¬ì¤˜ì•¼ í–ˆëŠ”ë°ìš”. JPAë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì €í¬ í”„ë¡œì íŠ¸ì—ì„œ ê°„ë‹¨í•˜ê²Œ ë– ì˜¬ë¦´ ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì•˜ìŠµë‹ˆë‹¤.

- OneToMany ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ ì‚¬ìš©í•´ í•˜ë‚˜ì˜ ì¿ í°ê·¸ë£¹ ì¡°íšŒì‹œ í•´ë‹¹ ì¿ í°ê·¸ë£¹ì˜ ì¿ í°ë“¤ì„ ì¡°íšŒ

## OneToMany ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ ì´ìš©?

OneToMany ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ ì´ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì—”í‹°í‹°ë¥¼ êµ¬ì„±í•´ì•¼ í–ˆìŠµë‹ˆë‹¤.

```java
@Entity
public class Coupon {
  // ...

  @JoinColumn(name = "coupon_group_id")
  @ManyToOne(fetch = FetchType.LAZY)
  private CouponGroup couponGroup;

  // ...
}
```

```java
public class CouponGroup {
  // ...
  
  @OneToMany(mappedBy = "couponGroup")
  private List<Coupon> coupons;
}
```

ì´í›„ ì„œë¹„ìŠ¤ ë¡œì§ì—ì„œ ì•„ë˜ì™€ ê°™ì´ ì¿ í°ê·¸ë£¹ë‚´ì˜ ì¿ í°ë“¤ì„ ì¡°íšŒí•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

```java
Page<CouponGroup> couponGroups = couponGroupRepository.findAll(pageRequest);

Map<CouponGroup, List<Coupon>> couponGroupCouponMap = couponGroups.getContent().stream()
        .collect(Collectors.toMap(couponGroup -> couponGroup, CouponGroup::getCoupons));
```

í•˜ì§€ë§Œ ë§‰ìƒ ì½”ë“œë¥¼ ì‹¤í–‰ì‹œì¼œë³´ë©´ ì•„ë˜ì™€ ê°™ì€ ì¿¼ë¦¬ê°€ ë‚ ë¼ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
[Hibernate] 
    select
        coupongrou0_.id as id1_2_,
        coupongrou0_.finished_at as finished2_2_,
        coupongrou0_.promotion_id as promotio5_2_,
        coupongrou0_.started_at as started_3_2_,
        coupongrou0_.title as title4_2_ 
    from
        coupon_group coupongrou0_ limit ? // ì¿ í°ê·¸ë£¹ì„ ì „ì²´ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬
[Hibernate] 
    select
        // ìƒëµ
    from
        coupon coupons0_ 
    where
        coupons0_.coupon_group_id=? // íŠ¹ì • ì¿ í°ê·¸ë£¹ì˜ ì¿ í° ëª©ë¡ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ 1
[Hibernate] 
    select
        // ìƒëµ
    from
        coupon coupons0_ 
    where
        coupons0_.coupon_group_id=? // íŠ¹ì • ì¿ í°ê·¸ë£¹ì˜ ì¿ í° ëª©ë¡ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ 2
[Hibernate] 
    select
        // ìƒëµ
    from
        coupon coupons0_ 
    where
        coupons0_.coupon_group_id=? // íŠ¹ì • ì¿ í°ê·¸ë£¹ì˜ ì¿ í° ëª©ë¡ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ 3
```

ì¿¼ë¦¬ì˜ ê²°ê³¼ë¥¼ ë³´ë©´ `ì¿ í°ê·¸ë£¹`ì„ ì „ì²´ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ 1ë²ˆ, ê°ê°ì˜ ì¿ í°ê·¸ë£¹ì— ëŒ€í•˜ì—¬ `ì¿ í°` ëª©ë¡ì´ ì¡°íšŒë˜ëŠ” ì¿¼ë¦¬ê°€ Në²ˆ ë‚ ë¼ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì¿ í°ê·¸ë£¹ì˜ ê°œìˆ˜ê°€ ë§ì•„ì§ˆìˆ˜ë¡ ì„±ëŠ¥ì´ ë–¨ì–´ì§€ê¸° ë•Œë¬¸ì— ê°œì„ í•´ì•¼í•©ë‹ˆë‹¤.

## Fetch Join

N + 1 ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²• ì¤‘ ë¨¼ì € FETCH JOINì„ ì‚¬ìš©í•´ ë¬¸ì œë¥¼ í•´ê²°í•´ë³´ê³ ì í–ˆìŠµë‹ˆë‹¤. 

- OneToMany ê´€ê³„ì—ì„œ ì¡°ì¸ì„ í•˜ê²Œ ë˜ë©´ ì¹´í…Œì‹œì•ˆ ê³±ì´ ë°œìƒí•´ ì˜ë„ì™€ëŠ” ë‹¤ë¥¸ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— `DISTINCT` í‚¤ì›Œë“œë¥¼ ë¶™ì—¬ ì¤‘ë³µì„ ì œê±°í•©ë‹ˆë‹¤.
- í˜ì´ì§•ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” `@Query` ì— `countQuery` attributeë„ ë„£ì–´ì£¼ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ì•„ë˜ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

```java
@Query(value = "SELECT DISTINCT couponGroup FROM CouponGroup couponGroup JOIN FETCH couponGroup.coupons",
            countQuery = "SELECT COUNT(DISTINCT couponGroup) FROM CouponGroup couponGroup INNER JOIN couponGroup.coupons")
Page<CouponGroup> findAll(Pageable pageable);
```

> **ì™œ countQueryë¥¼ ë„£ì–´ì•¼ í•˜ëŠ”ê°€?ğŸ§**
JPAì—ì„œ `@Query`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  í˜ì´ì§•ì„ ìˆ˜í–‰í•˜ê²Œ ë˜ë©´ ì˜ë„í•˜ì§€ ì•Šì•˜ë˜ countQueryê°€ ë‚ ë¼ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë°ìš”, ì´ëŠ” `Page` ì¸í„°í˜ì´ìŠ¤ì˜ `getTotalElements()`ì˜ ë©”ì„œë“œì˜ ìˆ˜í–‰ ê²°ê³¼ë¥¼ ë°˜í™˜í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì´ ì•„ë‹Œê°€ ì˜ˆìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.
ë”°ë¼ì„œ `@Query`ë¥¼ ì‚¬ìš©í•´ ì§ì ‘ ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ í˜ì´ì§•ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ë³„ë„ì˜ countQueryê°€ í•„ìš”í•©ë‹ˆë‹¤.
> 

ê²°ê³¼ë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì¿¼ë¦¬ê°€ ë‚ ë¼ê°€ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
select
        distinct coupongrou0_.id as id1_2_0_,
        coupons1_.id as id1_1_1_,
        coupongrou0_.admin_nickname as admin_ni2_2_0_,
        coupongrou0_.finished_at as finished3_2_0_,
        coupongrou0_.promotion_id as promotio6_2_0_,
        coupongrou0_.started_at as started_4_2_0_,
        coupongrou0_.title as title5_2_0_,
        coupons1_.created_at as created_2_1_1_,
        coupons1_.coupon_group_id as coupon_g8_1_1_,
        coupons1_.discount as discount3_1_1_,
        coupons1_.initial_quantity as initial_4_1_1_,
        coupons1_.remain_quantity as remain_q5_1_1_,
        coupons1_.title as title6_1_1_,
        coupons1_.type as type7_1_1_,
        coupons1_.coupon_group_id as coupon_g8_1_0__,
        coupons1_.id as id1_1_0__ 
    from
        coupon_group coupongrou0_ 
    inner join
        coupon coupons1_ 
            on coupongrou0_.id=coupons1_.coupon_group_id
```

í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¡œ ì¡°ì¸ì„ í•´ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì´ìƒí•œ ì ì€ `LIMIT`ì´ ì•ˆë³´ì¸ë‹¤ëŠ” ì ì¸ë°ìš”. ë¡œê·¸ë¥¼ ë³´ë‹ˆ ì•„ë˜ì™€ ê°™ì€ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ìˆì—ˆìŠµë‹ˆë‹¤.

```sql
WARN firstResult/maxResults specified with collection fetch; applying in memory!
```

JPAë¥¼ ì‚¬ìš©í•  ë•Œ OneToMany ê´€ê³„ì—ì„œ FETCH JOINê³¼ Paginationì„ í•¨ê»˜ ì‚¬ìš©í•˜ë©´ ì¿¼ë¦¬ì˜ ê²°ê³¼ë¥¼ ëª¨ë‘ ë©”ëª¨ë¦¬ì— ì ì¬í•œ ë’¤ ë©”ëª¨ë¦¬ì—ì„œ í˜ì´ì§•ì„ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.  ì´ì™€ ê°™ì€ ë°©ë²•ì€ OOM(Out Of Memory)ë¬¸ì œë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì¢‹ì§€ ì•Šì€ ë°©ë²•ì…ë‹ˆë‹¤.

### default_batch_fetch_size ë¥¼ í†µí•œ ë¬¸ì œ í•´ê²°

JPAì˜ XXXToMany ê´€ê³„ì—ì„œ FETCH JOINê³¼ í˜ì´ì§•ì„ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— FETCH JOINì„ ì œê±°í•˜ê³  N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ `default_batch_fetch_size` ì˜µì…˜ì„ í†µí•´ ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

`default_batch_fetch_size` ì˜µì…˜ì„ í™œìš©í•˜ë©´ Lazy Loadingìœ¼ë¡œ ì¸í•´ ë°œìƒë˜ëŠ” Nê°œì˜ ì¿¼ë¦¬ë¥¼ ì„¤ì •í•œ ì˜µì…˜ë§Œí¼ ëª¨ì•„ IN ì ˆë¡œ ì²˜ë¦¬í•˜ê²Œ ë©ë‹ˆë‹¤. 
ì˜ˆë¥¼ë“¤ì–´ 100ê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•œë‹¤ê³  í–ˆì„ ë•Œ `default_batch_fetch_size` ì˜µì…˜ì„ 10ìœ¼ë¡œì„¤ì •í•˜ê²Œ ë˜ë©´ ë°œìƒí•˜ëŠ” ì¶”ê°€ ì¿¼ë¦¬ì˜ ìˆ˜ë¥¼ 100 / 10ìœ¼ë¡œ ì¤„ì¼ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

ì‹¤ì œë¡œ ë°œìƒí•˜ëŠ” ì¿¼ë¦¬ë¥¼ í™•ì¸í•´ë³¼ê¹Œìš”?

```sql
[Hibernate] 
    select
        coupongrou0_.id as id1_2_,
        coupongrou0_.admin_nickname as admin_ni2_2_,
        coupongrou0_.finished_at as finished3_2_,
        coupongrou0_.promotion_id as promotio6_2_,
        coupongrou0_.started_at as started_4_2_,
        coupongrou0_.title as title5_2_ 
    from
        coupon_group coupongrou0_ 
    order by
        coupongrou0_.id desc limit ?
[Hibernate] 
    select
        count(coupongrou0_.id) as col_0_0_ 
    from
        coupon_group coupongrou0_
[Hibernate] 
    select
        coupons0_.coupon_group_id as coupon_g8_1_1_,
        coupons0_.id as id1_1_1_,
        coupons0_.id as id1_1_0_,
        coupons0_.created_at as created_2_1_0_,
        coupons0_.coupon_group_id as coupon_g8_1_0_,
        coupons0_.discount as discount3_1_0_,
        coupons0_.initial_quantity as initial_4_1_0_,
        coupons0_.remain_quantity as remain_q5_1_0_,
        coupons0_.title as title6_1_0_,
        coupons0_.type as type7_1_0_ 
    from
        coupon coupons0_ 
    where
        coupons0_.coupon_group_id in (
            ?, ?, ?, ?, ?, ?, ?, ?, ?, ?
        )
```

ë§ˆì§€ë§‰ ì¿¼ë¦¬ë¥¼ í™•ì¸í•´ë³´ë©´ `IN` ì ˆì„ í†µí•´ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ë¬¼ë¡  ì´ ë°©ë²•ì—ë„ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¿ í°ê·¸ë£¹ì˜ ìˆ˜ê°€ êµ‰ì¥íˆ ë§ë‹¤ë©´ N/(ì˜µì…˜ìœ¼ë¡œ ì„¤ì •í•œ ê°’)ë²ˆì˜ ì¿¼ë¦¬ê°€ ì¶”ê°€ì ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ê²ƒì€ ì–´ì©” ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì €í¬ í”„ë¡œì íŠ¸ì—ì„œëŠ” í˜ì´ì§•ì„ í†µí•´ í•œ í˜ì´ì§€ë‹¹ ì¡°íšŒí•˜ëŠ” ì¿ í°ê·¸ë£¹ì˜ ìˆ˜ê°€ ì œí•œë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ì´ ë°©ë²•ì„ í†µí•´ N+1 ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
